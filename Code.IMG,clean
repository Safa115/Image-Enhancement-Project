import cv2
import os
import numpy as np
from glob import glob
import matplotlib.pyplot as plt
# ---------------------------------
# 1) Preprocessing Function
# ---------------------------------
def preprocess_image(path, target_size=(256, 256), apply_log=True, apply_sharpen=True):
    img = cv2.imread(path)
    if img is None:
        print(f"Warning: Could not read image {path}")
        return None

    # Grayscale
    gray = cv2.cvtColor(img, cv2.COLOR_BGR2GRAY)

    # Resize
    resized = cv2.resize(gray, target_size, interpolation=cv2.INTER_AREA)

    # Gaussian Blur (Denoising)
    denoised = cv2.GaussianBlur(resized, (3, 3), 0)

    # Log Transformation
    if apply_log:
        img_float = denoised.astype(np.float32) / 255.0
        c = 1.0
        log_img = c * np.log1p(img_float)
        log_img = cv2.normalize(log_img, None, 0, 255, cv2.NORM_MINMAX)
        log_img = log_img.astype(np.uint8)
    else:
        log_img = denoised

    # Sharpening
    if apply_sharpen:
        kernel = np.array([[0, -1, 0],
                           [-1, 5, -1],
                           [0, -1, 0]])
        sharpened = cv2.filter2D(log_img, -1, kernel)
    else:
        sharpened = log_img

    return img, resized, denoised, log_img, sharpened


# ---------------------------------
# 2) Display the results:
# ---------------------------------
def show_steps(path):
    original, gray_resized, denoised, log_img, sharpened = preprocess_image(path)

    titles = ["Original", "Grayscale + Resize", "Denoised (Gaussian)", "Log Transformation", "Sharpened"]
    images = [original, gray_resized, denoised, log_img, sharpened]

    plt.figure(figsize=(12, 10))
    for i in range(5):
        plt.subplot(2, 3, i+1)
        if i == 0:
            plt.imshow(cv2.cvtColor(images[i], cv2.COLOR_BGR2RGB))
        else:
            plt.imshow(images[i], cmap='gray')
        plt.title(titles[i])
        plt.axis("off")

    plt.tight_layout()
    plt.show()


# ---------------------------------
# 3) Run for One Image Only
# ---------------------------------
path = r"C:/Users/E.J.S/Downloads/Project IMG/archive (1)/Lung X-Ray Image/Lung X-Ray Image/Normal/1.jpg"
show_steps(path)